import folium
import polyline
from folium import PolyLine
from folium.plugins import HeatMap
from shapely.geometry import Point, LineString, box
import numpy as np
import matplotlib.pyplot as plt

import pandas as pd
import datetime
from datetime import datetime, timedelta

from src.config import Config
from src.maps import Maps
from src.utils import *

"""
Hypothesis: 
    - Emission same along a distance (CO2/m = const)
    - Emission same along a time (CO2/s = const)
"""

def raw_to_smart_data(data):
    """
    Convert raw data to raw data + google usable point
    :param data:
    :return:
    """
    pass

def smart_to_points_data(data):
    """
    Convert smart data to list of (gare_1, gare_2, points, CO2/m, n_w_point, s_e_point)
    :param data:
    :return:
    """
    pass

def points_to_polyline_data(data):
    """
    Convert points data to list of acctual polyline to draw (with info)
    :param data: list of [(northeast, southwest, [list of points], CO2m), ...]
    :return:
    """
    final_poly = solve_multi_poly(data)
    # write to csv
    with open("../data/final_poly.csv", "w") as f:
        for poly in final_poly:
            f.write(str(poly)+"\n")
    return final_poly

def draw_polyline_data(data, map, max_CO2m=10000):
    """
    Draw polyline data
    :param data: list of [(northeast, southwest, [list of points], CO2m), ...]
    :return:
    """
    for _, _, points, CO2 in data:
        map = draw_poly_with_color(points, CO2, map, CO2m_max=max_CO2m, simple_color=True)
    return map

def main():
    """
    Color in CO2/m
    """
    GO_ONLINE = False
    DATA_FROM_EXCEL = False
    DATA_FROM_JSON = False

    # create a config object
    print("Starting ...")
    config = Config()
    result_path = "../results/"
    map = Maps(config.MAPS_API_KEY)
    date_string = '2023-11-21 10:00:00.00'
    date_format = '%Y-%m-%d %H:%M:%S.%f'
    departure_date = datetime.strptime(date_string, date_format)
    map_vis = folium.Map(location=[48.19713493026252, 16.33754220312274], zoom_start=10)
    data = None
    if DATA_FROM_EXCEL:
        data = load_data(config.DATA_PATH)
    if DATA_FROM_JSON:
        data = load_data_from_json(config.DATA_PATH+"response.json")
    print("Data loaded")

    print(departure_date)
    origine = "48.19713493026252,16.33754220312274"
    dest = "47.819636923765096,13.063047316611627"
    if GO_ONLINE:
        distance, encoded_polyline, northeast, southwest = map.get_directions(origine, dest, departure_date, mode="driving")

        print("Distance: {} m".format(distance))
        print("Northeast: {}".format(northeast))
        print("Southwest: {}".format(southwest))
        print("Polyline: {}".format(encoded_polyline))

        with open(config.DATA_PATH+"response.json", "w") as f:
            f.write(str(distance)+"150"+"\n") #150 is the max CO2/m
            f.write(str(northeast))
            f.write(str(southwest)+"\n")
            f.write(str(encoded_polyline)+"\n")

        decoded = polyline.decode(encoded_polyline)
        print(decoded)
        decoded_polyline = PolyLine(locations=decoded, color="red")
        decoded_polyline.add_to(map_vis)

    Linz = [(48.19739, 16.33697), (48.19775, 16.33683), (48.1975, 16.33538), (48.19585, 16.32946), (48.19279, 16.31874), (48.19238, 16.31697), (48.19302, 16.31303), (48.19374, 16.30639), (48.19361, 16.30095), (48.19429, 16.29651), (48.19465, 16.28983), (48.19458, 16.28644), (48.19534, 16.28279), (48.19588, 16.27878), (48.19704, 16.2767), (48.19908, 16.27161), (48.20125, 16.26378), (48.20183, 16.2593), (48.20219, 16.2564), (48.20373, 16.25346), (48.20337, 16.24491), (48.20382, 16.24059), (48.20464, 16.2378), (48.20534, 16.23451), (48.20773, 16.23159), (48.20773, 16.22749), (48.20896, 16.22409), (48.20743, 16.22276), (48.20725, 16.22211), (48.20679, 16.22205), (48.20466, 16.22322), (48.2036, 16.22448), (48.20361, 16.22931), (48.2045, 16.23089), (48.20531, 16.23084), (48.20573, 16.23001), (48.2055, 16.2259), (48.20423, 16.22122), (48.20312, 16.21645), (48.20165, 16.21298), (48.19729, 16.20755), (48.19434, 16.20507), (48.1924, 16.2013), (48.19067, 16.19621), (48.18708, 16.18979), (48.18321, 16.18411), (48.18107, 16.17931), (48.17939, 16.17045), (48.17795, 16.1595), (48.17578, 16.14948), (48.17401, 16.13908), (48.1735, 16.13162), (48.17624, 16.11879), (48.17536, 16.1044), (48.17601, 16.09948), (48.17753, 16.09576), (48.1789, 16.09257), (48.17948, 16.08819), (48.17889, 16.0845), (48.17753, 16.08091), (48.17627, 16.07696), (48.17623, 16.0713), (48.17622, 16.06501), (48.17504, 16.05837), (48.17435, 16.05381), (48.17216, 16.04762), (48.17065, 16.04254), (48.16919, 16.03251), (48.16799, 16.0272), (48.16272, 16.01856), (48.16183, 16.01608), (48.16146, 16.0125), (48.1626, 16.0029), (48.16196, 15.99678), (48.16046, 15.99339), (48.15662, 15.98964), (48.15421, 15.98621), (48.15295, 15.98254), (48.15252, 15.97905), (48.15311, 15.97333), (48.15399, 15.97013), (48.15754, 15.95945), (48.15826, 15.95596), (48.15843, 15.95029), (48.15551, 15.93178), (48.15386, 15.90636), (48.15393, 15.90052), (48.15526, 15.89515), (48.15759, 15.89113), (48.1603, 15.8886), (48.16888, 15.88191), (48.17179, 15.87613), (48.1734, 15.8704), (48.17384, 15.86507), (48.17305, 15.85892), (48.17277, 15.85576), (48.17327, 15.8503), (48.17484, 15.84174), (48.17713, 15.83306), (48.17871, 15.82556), (48.18085, 15.81976), (48.18428, 15.8103), (48.18507, 15.80275), (48.18545, 15.79439), (48.18492, 15.78539), (48.18428, 15.77275), (48.18541, 15.7597), (48.18647, 15.74031), (48.18633, 15.72398), (48.18547, 15.70649), (48.18543, 15.69523), (48.18597, 15.6863), (48.18467, 15.67693), (48.18018, 15.6631), (48.17738, 15.65396), (48.17621, 15.64649), (48.17642, 15.6318), (48.17712, 15.61562), (48.17796, 15.59409), (48.17746, 15.57746), (48.17724, 15.56685), (48.17795, 15.55673), (48.17803, 15.54911), (48.17741, 15.54315), (48.17054, 15.51148), (48.16818, 15.49811), (48.16815, 15.49549), (48.16875, 15.48898), (48.17045, 15.47855), (48.17221, 15.47314), (48.18144, 15.44914), (48.18488, 15.43658), (48.18671, 15.42797), (48.18823, 15.40786), (48.18917, 15.39852), (48.19079, 15.39242), (48.19848, 15.3718), (48.2023, 15.36642), (48.20682, 15.36322), (48.21084, 15.36068), (48.21396, 15.35754), (48.2152, 15.3551), (48.2165, 15.34858), (48.21724, 15.33789), (48.21788, 15.3264), (48.21607, 15.3186), (48.21387, 15.3117), (48.21365, 15.30744), (48.21418, 15.30374), (48.21542, 15.29644), (48.21475, 15.28901), (48.2115, 15.27992), (48.20451, 15.26676), (48.19839, 15.2545), (48.19748, 15.24978), (48.19779, 15.24157), (48.19823, 15.23192), (48.19616, 15.22173), (48.19246, 15.20569), (48.18964, 15.19684), (48.18556, 15.19092), (48.18112, 15.18779), (48.1772, 15.18623), (48.17357, 15.18289), (48.16616, 15.16475), (48.1628, 15.15381), (48.16171, 15.14544), (48.16058, 15.12856), (48.15941, 15.11391), (48.15681, 15.10519), (48.15206, 15.09436), (48.13957, 15.0658), (48.13528, 15.05493), (48.1327, 15.04132), (48.13007, 15.02301), (48.12885, 15.01177), (48.12896, 15.00872), (48.13118, 14.99855), (48.13506, 14.98549), (48.13649, 14.97793), (48.13898, 14.95386), (48.13835, 14.93353), (48.13959, 14.92576), (48.14417, 14.91629), (48.14593, 14.91212), (48.14694, 14.90749), (48.14707, 14.89858), (48.14626, 14.876), (48.14568, 14.86353), (48.14425, 14.85441), (48.13946, 14.84542), (48.13722, 14.84033), (48.13419, 14.83256), (48.13091, 14.82815), (48.12681, 14.82327), (48.12447, 14.8179), (48.12039, 14.80669), (48.11953, 14.78812), (48.11883, 14.77949), (48.11916, 14.77487), (48.12078, 14.76532), (48.12136, 14.75728), (48.12061, 14.74909), (48.11752, 14.73587), (48.11652, 14.73013), (48.11614, 14.71914), (48.11568, 14.71022), (48.11329, 14.69644), (48.11219, 14.68743), (48.11218, 14.6794), (48.11356, 14.66879), (48.11564, 14.65992), (48.11742, 14.65354), (48.11868, 14.6469), (48.11807, 14.64114), (48.11611, 14.63446), (48.11558, 14.62951), (48.11646, 14.62511), (48.12236, 14.61596), (48.12596, 14.61097), (48.1286, 14.60654), (48.13031, 14.60122), (48.13121, 14.59667), (48.13302, 14.58964), (48.13544, 14.5851), (48.14293, 14.57555), (48.14988, 14.56325), (48.15251, 14.56039), (48.15541, 14.55834), (48.16248, 14.55384), (48.16817, 14.55025), (48.17669, 14.54627), (48.18186, 14.54176), (48.18735, 14.53397), (48.19606, 14.52094), (48.19791, 14.5162), (48.20026, 14.49646), (48.20199, 14.47933), (48.20414, 14.46318), (48.20597, 14.45295), (48.20727, 14.44077), (48.20924, 14.4323), (48.2115, 14.42602), (48.22139, 14.39902), (48.23121, 14.38134), (48.23418, 14.3728), (48.23643, 14.35678), (48.23682, 14.34826), (48.23587, 14.33885), (48.23374, 14.3256), (48.22899, 14.31487), (48.22476, 14.30553), (48.22491, 14.3017), (48.22678, 14.29929), (48.22922, 14.29832), (48.23438, 14.29786), (48.24188, 14.29762), (48.25631, 14.29717), (48.26132, 14.29738), (48.26346, 14.29792), (48.26596, 14.29775), (48.2712, 14.29565), (48.27577, 14.29506), (48.27786, 14.29491), (48.27934, 14.29396), (48.28074, 14.28834), (48.28346, 14.2846), (48.28428, 14.28459), (48.2859, 14.28642), (48.28781, 14.28761), (48.28898, 14.28762), (48.29016, 14.28809), (48.2905, 14.28952), (48.28981, 14.28986), (48.29073, 14.29098)]
    Salzburg = [(48.19739, 16.33697), (48.19279, 16.31874), (48.19429, 16.29651), (48.19534, 16.28279), (48.19908, 16.27161), (48.20183, 16.2593), (48.20373, 16.25346), (48.20337, 16.24491), (48.20534, 16.23451), (48.20773, 16.23159), (48.20773, 16.22749), (48.20896, 16.22409), (48.20679, 16.22205), (48.2036, 16.22448), (48.20361, 16.22931), (48.2045, 16.23089), (48.20573, 16.23001), (48.20423, 16.22122), (48.20165, 16.21298), (48.19729, 16.20755), (48.1924, 16.2013), (48.18708, 16.18979), (48.18107, 16.17931), (48.17939, 16.17045), (48.17578, 16.14948), (48.1735, 16.13162), (48.17624, 16.11879), (48.17536, 16.1044), (48.17753, 16.09576), (48.17948, 16.08819), (48.17753, 16.08091), (48.17504, 16.05837), (48.17065, 16.04254), (48.16799, 16.0272), (48.16272, 16.01856), (48.16146, 16.0125), (48.1626, 16.0029), (48.16046, 15.99339), (48.15421, 15.98621), (48.15252, 15.97905), (48.15399, 15.97013), (48.15754, 15.95945), (48.15843, 15.95029), (48.15386, 15.90636), (48.15526, 15.89515), (48.1603, 15.8886), (48.16888, 15.88191), (48.1734, 15.8704), (48.17305, 15.85892), (48.17484, 15.84174), (48.18085, 15.81976), (48.18507, 15.80275), (48.18492, 15.78539), (48.18541, 15.7597), (48.18647, 15.74031), (48.18547, 15.70649), (48.18597, 15.6863), (48.18467, 15.67693), (48.18018, 15.6631), (48.17621, 15.64649), (48.17712, 15.61562), (48.17746, 15.57746), (48.17741, 15.54315), (48.17054, 15.51148), (48.16815, 15.49549), (48.16875, 15.48898), (48.17221, 15.47314), (48.18144, 15.44914), (48.18671, 15.42797), (48.18823, 15.40786), (48.19079, 15.39242), (48.19848, 15.3718), (48.2023, 15.36642), (48.20682, 15.36322), (48.21084, 15.36068), (48.2152, 15.3551), (48.21724, 15.33789), (48.21788, 15.3264), (48.21607, 15.3186), (48.21387, 15.3117), (48.21418, 15.30374), (48.21475, 15.28901), (48.20451, 15.26676), (48.19839, 15.2545), (48.19779, 15.24157), (48.19823, 15.23192), (48.19616, 15.22173), (48.18964, 15.19684), (48.18556, 15.19092), (48.18112, 15.18779), (48.17357, 15.18289), (48.16616, 15.16475), (48.16171, 15.14544), (48.16058, 15.12856), (48.15941, 15.11391), (48.15206, 15.09436), (48.13957, 15.0658), (48.13528, 15.05493), (48.1327, 15.04132), (48.12885, 15.01177), (48.13118, 14.99855), (48.13649, 14.97793), (48.13898, 14.95386), (48.13835, 14.93353), (48.13959, 14.92576), (48.14417, 14.91629), (48.14694, 14.90749), (48.14707, 14.89858), (48.14626, 14.876), (48.14425, 14.85441), (48.13722, 14.84033), (48.13091, 14.82815), (48.12447, 14.8179), (48.12039, 14.80669), (48.11953, 14.78812), (48.11916, 14.77487), (48.12136, 14.75728), (48.11752, 14.73587), (48.11614, 14.71914), (48.11329, 14.69644), (48.11218, 14.6794), (48.11868, 14.6469), (48.11611, 14.63446), (48.11646, 14.62511), (48.12596, 14.61097), (48.1286, 14.60654), (48.13121, 14.59667), (48.13544, 14.5851), (48.14293, 14.57555), (48.14988, 14.56325), (48.16248, 14.55384), (48.17669, 14.54627), (48.18735, 14.53397), (48.19791, 14.5162), (48.20026, 14.49646), (48.20414, 14.46318), (48.20727, 14.44077), (48.2115, 14.42602), (48.22139, 14.39902), (48.23121, 14.38134), (48.23418, 14.3728), (48.23643, 14.35678), (48.23587, 14.33885), (48.23374, 14.3256), (48.22899, 14.31487), (48.22186, 14.30004), (48.19837, 14.2485), (48.19128, 14.23015), (48.18841, 14.20815), (48.18436, 14.19589), (48.17437, 14.17589), (48.15773, 14.16049), (48.14408, 14.1453), (48.13465, 14.12847), (48.12483, 14.11437), (48.11179, 14.09936), (48.09075, 14.06948), (48.05952, 14.03441), (48.05574, 14.02993), (48.0521, 14.02131), (48.04749, 14.00792), (48.04087, 13.99147), (48.03013, 13.97439), (48.02339, 13.96276), (48.01691, 13.94434), (48.01027, 13.92413), (48.00596, 13.9095), (48.00363, 13.89696), (48.00309, 13.88061), (48.00486, 13.84067), (48.00315, 13.82167), (48.00083, 13.80486), (47.99773, 13.79676), (47.99191, 13.78418), (47.98749, 13.77856), (47.97618, 13.77032), (47.96847, 13.76434), (47.9634, 13.75331), (47.95787, 13.73557), (47.95325, 13.72696), (47.95024, 13.70738), (47.95125, 13.69909), (47.94931, 13.68835), (47.94836, 13.67753), (47.94996, 13.66885), (47.955, 13.65755), (47.95686, 13.64571), (47.95131, 13.61946), (47.95179, 13.60772), (47.95484, 13.59384), (47.95853, 13.56753), (47.95605, 13.54894), (47.95385, 13.53225), (47.94754, 13.52059), (47.93717, 13.51537), (47.9289, 13.5092), (47.9208, 13.49956), (47.91821, 13.49316), (47.91807, 13.47954), (47.91835, 13.47033), (47.91632, 13.46186), (47.91208, 13.45413), (47.90647, 13.44866), (47.89421, 13.43959), (47.88603, 13.43344), (47.87902, 13.43319), (47.8653, 13.43754), (47.84655, 13.44131), (47.84152, 13.4368), (47.83786, 13.4256), (47.83623, 13.41657), (47.83776, 13.40592), (47.83756, 13.39344), (47.84321, 13.3824), (47.84998, 13.36666), (47.8569, 13.35575), (47.86233, 13.34849), (47.8635, 13.34142), (47.86213, 13.33693), (47.85783, 13.33289), (47.85418, 13.33026), (47.84928, 13.32216), (47.84497, 13.30979), (47.84352, 13.26821), (47.8471, 13.24855), (47.85126, 13.22972), (47.8548, 13.22033), (47.85562, 13.212), (47.8553, 13.19743), (47.85149, 13.18864), (47.85072, 13.17901), (47.85411, 13.15863), (47.85617, 13.12629), (47.85278, 13.10776), (47.85051, 13.08644), (47.84771, 13.07975), (47.84204, 13.07869), (47.83301, 13.07172), (47.83051, 13.06603), (47.83159, 13.05461), (47.83244, 13.05556), (47.8314, 13.05643), (47.82889, 13.05637), (47.82549, 13.0543), (47.82633, 13.05549), (47.82565, 13.05753), (47.82413, 13.05974), (47.81996, 13.06351)]
    Other = [(48.22186, 14.30004), (48.19837, 14.2485), (48.19128, 14.23015), (48.18841, 14.20815), (48.18436, 14.19589), (48.17437, 14.17589), (48.15773, 14.16049), (48.14408, 14.1453), (48.13465, 14.12847), (48.12483, 14.11437), (48.11179, 14.09936), (48.09075, 14.06948), (48.05952, 14.03441), (48.05574, 14.02993), (48.0521, 14.02131), (48.04749, 14.00792), (48.04087, 13.99147), (48.03013, 13.97439), (48.02339, 13.96276), (48.01691, 13.94434), (48.01027, 13.92413), (48.00596, 13.9095), (48.00363, 13.89696), (48.00309, 13.88061), (48.00486, 13.84067), (48.00315, 13.82167), (48.00083, 13.80486), (47.99773, 13.79676), (47.99191, 13.78418), (47.98749, 13.77856), (47.97618, 13.77032), (47.96847, 13.76434), (47.9634, 13.75331), (47.95787, 13.73557), (47.95325, 13.72696), (47.95024, 13.70738), (47.95125, 13.69909), (47.94931, 13.68835), (47.94836, 13.67753), (47.94996, 13.66885), (47.955, 13.65755), (47.95686, 13.64571), (47.95131, 13.61946), (47.95179, 13.60772), (47.95484, 13.59384), (47.95853, 13.56753), (47.95605, 13.54894), (47.95385, 13.53225), (47.94754, 13.52059), (47.93717, 13.51537), (47.9289, 13.5092), (47.9208, 13.49956), (47.91821, 13.49316), (47.91807, 13.47954), (47.91835, 13.47033), (47.91632, 13.46186), (47.91208, 13.45413), (47.90647, 13.44866), (47.89421, 13.43959), (47.88603, 13.43344), (47.87902, 13.43319), (47.8653, 13.43754), (47.84655, 13.44131), (47.84152, 13.4368), (47.83786, 13.4256), (47.83623, 13.41657), (47.83776, 13.40592), (47.83756, 13.39344), (47.84321, 13.3824), (47.84998, 13.36666), (47.8569, 13.35575), (47.86233, 13.34849), (47.8635, 13.34142), (47.86213, 13.33693), (47.85783, 13.33289), (47.85418, 13.33026), (47.84928, 13.32216), (47.84497, 13.30979), (47.84352, 13.26821), (47.8471, 13.24855), (47.85126, 13.22972), (47.8548, 13.22033), (47.85562, 13.212), (47.8553, 13.19743), (47.85149, 13.18864), (47.85072, 13.17901), (47.85411, 13.15863), (47.85617, 13.12629), (47.85278, 13.10776), (47.85051, 13.08644), (47.84771, 13.07975), (47.84204, 13.07869), (47.83301, 13.07172), (47.83051, 13.06603), (47.83159, 13.05461), (47.83244, 13.05556), (47.8314, 13.05643), (47.82889, 13.05637), (47.82549, 13.0543), (47.82633, 13.05549), (47.82565, 13.05753), (47.82413, 13.05974), (47.81996, 13.06351)]

    polines = [[*get_northeast_southwest(Linz), Linz, 1500], [*get_northeast_southwest(Salzburg), Salzburg, 1500]]
    map_vis = draw_polyline_data(points_to_polyline_data(polines), map_vis)
    # Other_poly = PolyLine(locations=Other, color="green")
    # Other_poly.add_to(map_vis)

    # Linz_polyline = PolyLine(locations=Linz, color="blue")
    # Salzburg_polyline = PolyLine(locations=Salzburg, color="red")
    # # Linz_polyline.add_to(map_vis)
    # Salzburg_polyline.add_to(map_vis)
    #
    # # list of 274 value from 0 to 1000
    # Co2_linz = [1000*e/274 for e in range(274)]
    #
    # map_vis = draw_poly_with_color(Linz, Co2_linz, map_vis)
    #
    # save the map
    map_vis.save(result_path+"map.html")


if __name__ == "__main__":
    main()
